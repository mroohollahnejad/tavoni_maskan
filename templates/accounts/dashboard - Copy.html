{% load static %}
{% load humanize %}
{% load jformat %}
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ú©Ø§Ø±Ø¨Ø±</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- Persian Datepicker -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css">
<script src="https://cdn.jsdelivr.net/npm/persian-date@1.1.0/dist/persian-date.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>

<style>
body {
  background: linear-gradient(135deg, #5b9bd5, #2b5797);
  font-family: "Vazirmatn", sans-serif;
  color: #fff;
  min-height: 100vh;
  padding: 20px 0;
}
.container { max-width: 1000px; }
.card {
  background: rgba(255, 255, 255, 0.95);
  border-radius: 20px;
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
  padding: 2rem;
}
.table th {
  background: linear-gradient(90deg, #007bff, #00bfff);
  color: #fff;
  font-weight: bold;
}
.table td { color: #000; }
.table-hover tbody tr:hover { background-color: rgba(0, 123, 255, 0.1); }
.btn-edit { background-color: #00bfff; border: none; color: #fff; font-weight: bold; transition: 0.3s; }
.btn-edit:hover { background-color: #0099cc; }
.btn-logout { background-color: #e74c3c; border: none; color: #fff; font-weight: bold; }
.profile-header img { box-shadow: 0 0 10px rgba(0, 123, 255, 0.5); }
.info-item { background: rgba(0, 123, 255, 0.1); padding: 10px; border-radius: 10px; margin-bottom: 8px; display: flex; justify-content: space-between; flex-wrap: wrap; }
.nav-tabs .nav-link { cursor: pointer; }
@media(max-width:576px){ .info-item { flex-direction: column; align-items: flex-start; } }
</style>
</head>
<body>

<div class="container">
<div class="card">
  <div class="profile-header text-center mb-3">
    <h4 class="mt-2 text-primary">ğŸ‘‹ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒ {{ user.username }}</h4>
  </div>

  <!-- ØªØ¨â€ŒÙ‡Ø§ -->
  <ul class="nav nav-tabs mb-3 flex-wrap">
    <li class="nav-item"><button class="nav-link {% if active_tab == 'personal' %}active{% endif %}" data-bs-toggle="tab" data-bs-target="#personal">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù‡ÙˆÛŒØªÛŒ</button></li>
    <li class="nav-item"><button class="nav-link {% if active_tab == 'financial' %}active{% endif %}" data-bs-toggle="tab" data-bs-target="#financial">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø§Ù„ÛŒ</button></li>
    <li class="nav-item"><button class="nav-link {% if active_tab == 'score' %}active{% endif %}" data-bs-toggle="tab" data-bs-target="#score">Ø§Ù…ØªÛŒØ§Ø² Ø¹Ø¶Ùˆ</button></li>
  </ul>

  <div class="tab-content">
    <!-- ØªØ¨ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù‡ÙˆÛŒØªÛŒ -->
    <div class="tab-pane fade {% if active_tab == 'personal' %}show active{% endif %}" id="personal">
      <div class="info-item"><strong>Ù†Ø§Ù…:</strong> <span>{{ user.first_name|default:"-" }}</span></div>
      <div class="info-item"><strong>Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ:</strong> <span>{{ user.last_name|default:"-" }}</span></div>
      <div class="info-item"><strong>Ø§ÛŒÙ…ÛŒÙ„:</strong> <span>{{ user.email|default:"-" }}</span></div>
      <div class="info-item"><strong>Ø´Ù…Ø§Ø±Ù‡ Ù…Ù„ÛŒ:</strong> <span>{{ profile.national_code|default:"-" }}</span></div>
      <div class="info-item"><strong>Ø´Ù…Ø§Ø±Ù‡ Ø´Ù†Ø§Ø³Ù†Ø§Ù…Ù‡:</strong> <span>{{ profile.birth_certificate|default:"-" }}</span></div>
      <div class="info-item"><strong>Ø´Ù…Ø§Ø±Ù‡ Ù‡Ù…Ø±Ø§Ù‡:</strong> <span>{{ profile.phone_number|default:"-" }}</span></div>
      <div class="info-item"><strong>ØªØ§Ø±ÛŒØ® ØªÙˆÙ„Ø¯:</strong> <span>{{ profile.birth_date|default_if_none:"-"|jformat:"%Y-%m-%d" }}</span></div>
      <div class="info-item"><strong>Ù…Ø­Ù„ ØªÙˆÙ„Ø¯:</strong> <span>{{ profile.birth_place|default:"-" }}</span></div>

      <div class="text-center mt-4 d-flex flex-column gap-2">
        <a href="{% url 'profile_edit' %}" class="btn btn-edit w-100">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾Ø±ÙˆÙØ§ÛŒÙ„</a>
        <form method="post" action="{% url 'logout' %}">{% csrf_token %}
          <button type="submit" class="btn btn-logout w-100">ğŸšª Ø®Ø±ÙˆØ¬</button>
        </form>
      </div>
    </div>

    <!-- ØªØ¨ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø§Ù„ÛŒ -->
    <div class="tab-pane fade {% if active_tab == 'financial' %}show active{% endif %}" id="financial">
      <form id="paymentForm" class="payment-form mt-3">
        {% csrf_token %}
        <div class="row g-3">
          <div class="col-md-4">
            <label>Ù†ÙˆØ¨Øª ÙˆØ§Ø±ÛŒØ²ÛŒ</label>
            <select name="installment_number" id="id_installment_number" class="form-select">
              {% for i in installments %}
                <option value="{{ i }}">Ù†ÙˆØ¨Øª {{ i }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-4">
            <label>Ù…Ø¨Ù„Øº (Ø±ÛŒØ§Ù„)</label>
            <input type="number" name="amount" class="form-control" required min="1">
          </div>
          <div class="col-md-4">
            <label>ØªØ§Ø±ÛŒØ® ÙˆØ§Ø±ÛŒØ²</label>
            <input type="text" id="payment_date" name="payment_date" class="form-control" placeholder="YYYY-MM-DD" required>
          </div>
          <div class="col-md-4 mt-3">
            <label>ØªØ§Ø±ÛŒØ® Ù…ØµÙˆØ¨ ÙˆØ§Ø±ÛŒØ²ÛŒ</label>
            <input type="text" id="id_due_date" name="due_date" class="form-control" readonly>
          </div>
        </div>
        <div class="text-center mt-3">
          <button type="submit" class="btn btn-edit w-50">ğŸ’¾ Ø«Ø¨Øª ÙˆØ§Ø±ÛŒØ²ÛŒ</button>
        </div>
      </form>

      <div id="alertBox" class="mt-3"></div>

      <div class="table-responsive mt-3">
        <table class="table table-hover" id="paymentsTable">
          <thead>
            <tr>
              <th>Ù†ÙˆØ¨Øª</th>
              <th>Ù…Ø¨Ù„Øº</th>
              <th>ØªØ§Ø±ÛŒØ® ÙˆØ§Ø±ÛŒØ²</th>
              <th>ØªØ§Ø±ÛŒØ® Ù…ØµÙˆØ¨</th>
              <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
            </tr>
          </thead>
          <tbody>
            {% for p in payments %}
              <tr data-id="{{ p.id }}">
                <td class="editable" data-field="installment_number">{{ p.installment_number }}</td>
                <td class="editable" data-field="amount">{{ p.amount|intcomma }}</td>
                <td class="editable" data-field="payment_date">{{ p.payment_date_j }}</td>
                <td>{{ p.due_date_j }}</td>
                <td><button class="btn btn-sm btn-danger delete-btn">Ø­Ø°Ù</button></td>
              </tr>
            {% empty %}
              <tr><td colspan="5" class="text-center text-warning">Ù‡Ù†ÙˆØ² ÙˆØ§Ø±ÛŒØ²ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- ØªØ¨ Ø§Ù…ØªÛŒØ§Ø² -->
    <div class="tab-pane fade {% if active_tab == 'score' %}show active{% endif %}" id="score">
      <div class="text-center mt-4">
        <h5 class="text-primary fw-bold">ğŸ¯ Ø§Ù…ØªÛŒØ§Ø² Ú©Ù„: <span id="totalScore">{{ total_score|floatformat:2 }}</span></h5>
        <h5 class="text-success fw-bold mt-3">ğŸ† Ø±ØªØ¨Ù‡ Ø´Ù…Ø§ Ø¯Ø± Ø¨ÛŒÙ† Ø§Ø¹Ø¶Ø§: {{ rank }}</h5>
      </div>

      <div class="table-responsive mt-4">
        <table class="table table-striped table-bordered text-center align-middle" id="scoreTable">
          <thead class="table-primary">
            <tr>
              <th>Ù†ÙˆØ¨Øª</th>
              <th>Ù…Ø¨Ù„Øº ÙˆØ§Ø±ÛŒØ²ÛŒ</th>
              <th>ØªØ§Ø±ÛŒØ® ÙˆØ§Ø±ÛŒØ²</th>
              <th>ØªØ§Ø±ÛŒØ® Ù…ØµÙˆØ¨</th>
              <th>Ø§Ø®ØªÙ„Ø§Ù Ø±ÙˆØ²</th>
              <th>Ø§Ù…ØªÛŒØ§Ø²</th>
            </tr>
          </thead>
          <tbody id="scoreTableBody">
            {% for p in payments %}
              <tr>
                <td>{{ p.installment_number }}</td>
                <td>{{ p.amount|intcomma }}</td>
                <td>{{ p.payment_date_j }}</td>
                <td>{{ p.due_date_j }}</td>
                <td>{{ p.diff_days }}</td>
                <td>{{ p.score|floatformat:2 }}</td>
              </tr>
            {% empty %}
              <tr><td colspan="6" class="text-center text-muted">Ø¯Ø± Ø­Ø§Ù„ Ù…Ø­Ø§Ø³Ø¨Ù‡...</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
</div>

<script>
$(document).ready(function() {
  const approvedDates = {
    {% for k,v in approved_dates.items %}
      '{{ k }}': '{{ v|default_if_none:""|jformat:"%Y-%m-%d" }}',
    {% endfor %}
  };
  const csrfToken = '{{ csrf_token }}';

  $("#payment_date").persianDatepicker({
    format: "YYYY-MM-DD", initialValue: false, autoClose: true, calendarType: "persian"
  });

  $('#id_installment_number').on('change', function(){
    const val = $(this).val();
    $('#id_due_date').val(approvedDates[val] || '');
  }).trigger('change');

  // ğŸ”¹ ØªØ§Ø¨Ø¹ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªØ¨ Ø§Ù…ØªÛŒØ§Ø²
  function updateScoreTab() {
    $.get("{% url 'score_ajax' %}", function (data) {
      $("#totalScore").text(data.total_score.toFixed(2));
      const tbody = $("#scoreTableBody");
      tbody.empty();
      data.payments.forEach(p => {
        const row = `<tr>
          <td>${p.installment_number}</td>
          <td>${p.amount}</td>
          <td>${p.payment_date}</td>
          <td>${p.due_date}</td>
          <td>${p.diff_days}</td>
          <td>${p.score}</td>
        </tr>`;
        tbody.append(row);
      });
    });
  }

  // Ø«Ø¨Øª ÙˆØ§Ø±ÛŒØ²ÛŒ
  $('#paymentForm').on('submit', function (e) {
    e.preventDefault();
    $.ajax({
      type: 'POST',
      url: "{% url 'payment_create_ajax' %}",
      data: $(this).serialize(),
      beforeSend: xhr => xhr.setRequestHeader("X-CSRFToken", csrfToken),
      success: function (response) {
        if (response.status === 'success') {
          const p = response.payment;
          const newRow = `<tr data-id="${p.id}">
              <td class="editable" data-field="installment_number">${p.installment_number}</td>
              <td class="editable" data-field="amount">${p.amount}</td>
              <td class="editable" data-field="payment_date">${p.payment_date}</td>
              <td>${p.due_date}</td>
              <td><button class="btn btn-sm btn-danger delete-btn">Ø­Ø°Ù</button></td>
            </tr>`;
          $('#paymentsTable tbody').append(newRow);
          updateScoreTab(); // ğŸ”¹ ØªØ¨ Ø§Ù…ØªÛŒØ§Ø² Ø¨Ù„Ø§ÙØ§ØµÙ„Ù‡ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´ÙˆØ¯
        } else alert(response.message);
      }
    });
  });

  // Ø­Ø°Ù
  $(document).on('click', '.delete-btn', function () {
    const row = $(this).closest('tr');
    const id = row.data('id');
    if (!confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† ÙˆØ§Ø±ÛŒØ²ÛŒ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')) return;
    $.post("{% url 'payment_delete_ajax' pk=0 %}".replace('0', id),
      { csrfmiddlewaretoken: csrfToken },
      function (response) {
        if (response.status === 'success') { row.remove(); updateScoreTab(); }
        else alert(response.message);
      });
  });

  // ÙˆÛŒØ±Ø§ÛŒØ´
  $(document).on('click', '.editable', function () {
    const td = $(this);
    const oldValue = td.text().trim();
    const field = td.data('field');
    const id = td.closest('tr').data('id');
    if (td.find('input').length) return;
    const input = $('<input type="text" class="form-control form-control-sm">').val(oldValue);
    td.empty().append(input).focus();

    input.on('blur keydown', function (e) {
      if (e.type === 'blur' || e.key === 'Enter') {
        const newValue = input.val().trim();
        if (newValue && newValue !== oldValue) {
          $.post("{% url 'payment_edit_ajax' pk=0 %}".replace('0', id),
            { field, value: newValue, csrfmiddlewaretoken: csrfToken },
            function (response) {
              if (response.status === 'success') { td.text(newValue); updateScoreTab(); }
              else td.text(oldValue);
            });
        } else td.text(oldValue);
      }
    });
  });
});
</script>

</body>
</html>
