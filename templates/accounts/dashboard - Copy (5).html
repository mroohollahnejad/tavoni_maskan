{% load static %}
{% load humanize %}
{% load jformat %}
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ú©Ø§Ø±Ø¨Ø±</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- Persian Datepicker -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css">
<script src="https://cdn.jsdelivr.net/npm/persian-date@1.1.0/dist/persian-date.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>

<style>
body { background: #f0f2f5; font-family: "Vazirmatn", sans-serif; min-height: 100vh; padding: 20px 0; color: #333; }
.container { max-width: 1200px; }
.card { background: #fff; border-radius: 15px; box-shadow: 0 6px 15px rgba(0,0,0,0.1); padding: 1.5rem; margin-bottom: 20px; }
.nav-tabs .nav-link { font-weight: bold; color: #555; transition: 0.3s; }
.nav-tabs .nav-link.active { color: #fff !important; background: linear-gradient(90deg, #007bff, #00bfff); border-radius: 10px; }
.info-item { background: #f0f8ff; padding: 12px; border-radius: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; flex-wrap: wrap; }
.table th { background: linear-gradient(90deg, #007bff, #00bfff); color: #fff; font-weight: bold; }
.table td { color: #333; }
.table-hover tbody tr:hover { background-color: rgba(0, 123, 255, 0.05); }
.btn-edit { background-color: #00bfff; border: none; color: #fff; font-weight: bold; transition: 0.3s; }
.btn-edit:hover { background-color: #0099cc; }
.btn-logout { background-color: #e74c3c; border: none; color: #fff; font-weight: bold; }
.progress { height: 25px; border-radius: 15px; }
.progress-bar { font-weight: bold; }
@media(max-width:768px){ .info-item { flex-direction: column; align-items: flex-start; } }
</style>
</head>
<body>

<div class="container">
<div class="card">
  <div class="profile-header text-center mb-4">
    <h3 class="text-primary">ğŸ‘‹ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒ {{ user.username }}</h3>
  </div>

<!-- ØªØ¨â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ù„Ø§ÛŒ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ -->
<ul class="nav nav-tabs mb-4 flex-wrap align-items-center">
  <li class="nav-item">
    <button class="nav-link {% if active_tab == 'personal' %}active{% endif %}" data-bs-toggle="tab" data-bs-target="#personal">
      <i class="bi bi-person-badge me-1"></i> Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù‡ÙˆÛŒØªÛŒ
    </button>
  </li>
  <li class="nav-item">
    <button class="nav-link {% if active_tab == 'financial' %}active{% endif %}" data-bs-toggle="tab" data-bs-target="#financial">
      <i class="bi bi-cash-coin me-1"></i> Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø§Ù„ÛŒ
    </button>
  </li>
  <li class="nav-item">
    <button class="nav-link {% if active_tab == 'score' %}active{% endif %}" data-bs-toggle="tab" data-bs-target="#score">
      <i class="bi bi-trophy me-1"></i> Ø§Ù…ØªÛŒØ§Ø² Ùˆ Ø±ØªØ¨Ù‡
    </button>
  </li>
  <li class="nav-item ms-auto">
    <form method="post" action="{% url 'logout' %}" class="d-inline">
      {% csrf_token %}
      <button class="nav-link logout-tab" type="submit">
        <i class="bi bi-box-arrow-right me-1"></i> Ø®Ø±ÙˆØ¬
      </button>
    </form>
  </li>
</ul>

<!-- Ø¢ÛŒÚ©ÙˆÙ†â€ŒÙ‡Ø§ÛŒ Bootstrap -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

<!-- ğŸ¨ Ø§Ø³ØªØ§ÛŒÙ„ Ø³Ø¨Ø² Ù…Ø¯Ø±Ù† -->
<style>
  /* Ø§Ø³ØªØ§ÛŒÙ„ Ø¹Ù…ÙˆÙ…ÛŒ ØªØ¨â€ŒÙ‡Ø§ */
  .nav-tabs .nav-link {
    color: #198754;
    font-weight: 500;
    transition: all 0.3s ease;
    border: none;
  }

  .nav-tabs .nav-link:hover {
    background-color: #d1fae5;
    color: #0f5132;
    border-radius: 0.375rem;
  }

  .nav-tabs .nav-link.active {
    background-color: #198754;
    color: #fff !important;
    border-radius: 0.375rem;
    font-weight: 600;
  }

  /* Ø¯Ú©Ù…Ù‡ Ø®Ø±ÙˆØ¬ */
  .logout-tab {
    color: #16a34a !important;
    background: transparent;
    border: none;
    font-weight: 500;
    transition: all 0.3s ease;
  }

  .logout-tab:hover {
    color: #fff !important;
    background-color: #16a34a;
    border-radius: 0.375rem;
  }

  .logout-tab:focus {
    box-shadow: none !important;
  }
</style>


  <div class="tab-content">

    <!-- ØªØ¨ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù‡ÙˆÛŒØªÛŒ -->
    <div class="tab-pane fade {% if active_tab == 'personal' %}show active{% endif %}" id="personal">
      <div class="row">
        <div class="col-md-6">
          <div class="info-item"><strong>Ù†Ø§Ù…:</strong> <span>{{ user.first_name|default:"-" }}</span></div>
          <div class="info-item"><strong>Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ:</strong> <span>{{ user.last_name|default:"-" }}</span></div>
          <div class="info-item"><strong>Ø§ÛŒÙ…ÛŒÙ„:</strong> <span>{{ user.email|default:"-" }}</span></div>
          <div class="info-item"><strong>Ø´Ù…Ø§Ø±Ù‡ Ù…Ù„ÛŒ:</strong> <span>{{ profile.national_code|default:"-" }}</span></div>
        </div>
        <div class="col-md-6">
          <div class="info-item"><strong>Ø´Ù…Ø§Ø±Ù‡ Ø´Ù†Ø§Ø³Ù†Ø§Ù…Ù‡:</strong> <span>{{ profile.birth_certificate|default:"-" }}</span></div>
          <div class="info-item"><strong>Ø´Ù…Ø§Ø±Ù‡ Ù‡Ù…Ø±Ø§Ù‡:</strong> <span>{{ profile.phone_number|default:"-" }}</span></div>
          <div class="info-item"><strong>ØªØ§Ø±ÛŒØ® ØªÙˆÙ„Ø¯:</strong> <span>{{ profile.birth_date|default_if_none:"-"|jformat:"%Y-%m-%d" }}</span></div>
          <div class="info-item"><strong>Ù…Ø­Ù„ ØªÙˆÙ„Ø¯:</strong> <span>{{ profile.birth_place|default:"-" }}</span></div>
        </div>
      </div>

      <div class="text-center mt-4 d-flex flex-column gap-2">
        <a href="{% url 'profile_edit' %}" class="btn btn-edit w-100">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾Ø±ÙˆÙØ§ÛŒÙ„</a>
      </div>
    </div>

    <!-- ØªØ¨ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø§Ù„ÛŒ -->
    <div class="tab-pane fade {% if active_tab == 'financial' %}show active{% endif %}" id="financial">
      <form id="paymentForm">
        <div class="row g-3 mb-4">
          <div class="col-md-3">
            <div class="card p-3 shadow-sm">
              <h6>Ù†ÙˆØ¨Øª ÙˆØ§Ø±ÛŒØ²ÛŒ</h6>
              <select name="installment_number" id="id_installment_number" class="form-select">
                {% for i in installments %}
                  <option value="{{ i }}">Ù†ÙˆØ¨Øª {{ i }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card p-3 shadow-sm">
              <h6>Ù…Ø¨Ù„Øº ÙˆØ§Ø±ÛŒØ²ÛŒ</h6>
              <input type="number" name="amount" id="id_amount" class="form-control" min="1">
            </div>
          </div>
          <div class="col-md-3">
            <div class="card p-3 shadow-sm">
              <h6>ØªØ§Ø±ÛŒØ® ÙˆØ§Ø±ÛŒØ²</h6>
              <input type="text" id="payment_date" name="payment_date" class="form-control" placeholder="YYYY-MM-DD">
            </div>
          </div>
          <div class="col-md-3">
            <div class="card p-3 shadow-sm">
              <h6>ØªØ§Ø±ÛŒØ® Ù…ØµÙˆØ¨</h6>
              <input type="text" id="id_due_date" name="due_date" class="form-control" readonly>
            </div>
          </div>
        </div>
        <div class="text-center mb-4">
          <button id="btn_add_payment" class="btn btn-edit w-50" type="button">ğŸ’¾ Ø«Ø¨Øª ÙˆØ§Ø±ÛŒØ²ÛŒ</button>
        </div>
      </form>

      <!-- Ø¬Ø¯ÙˆÙ„ ÙˆØ§Ø±ÛŒØ²ÛŒâ€ŒÙ‡Ø§ -->
      <div class="table-responsive" style="max-height:400px; overflow:auto;">
        <table class="table table-hover table-bordered align-middle">
          <thead class="table-primary">
            <tr>
              <th>Ù†ÙˆØ¨Øª</th>
              <th>Ù…Ø¨Ù„Øº(ØªÙˆÙ…Ø§Ù†)</th>
              <th>ØªØ§Ø±ÛŒØ® ÙˆØ§Ø±ÛŒØ²</th>
              <th>ØªØ§Ø±ÛŒØ® Ù…ØµÙˆØ¨</th>
              <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
            </tr>
          </thead>
          <tbody id="paymentsTable">
            {% for p in payments %}
              <tr data-id="{{ p.id }}">
                <td>{{ p.installment_number }}</td>
                <td>{{ p.amount}}</td>
                <td>{{ p.payment_date_j }}</td>
                <td>{{ p.due_date_j }}</td>
                <td><button class="btn btn-sm btn-danger delete-btn">Ø­Ø°Ù</button></td>
              </tr>
            {% empty %}
              <tr><td colspan="5" class="text-center text-muted">Ù‡Ù†ÙˆØ² ÙˆØ§Ø±ÛŒØ²ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- ØªØ¨ Ø§Ù…ØªÛŒØ§Ø² Ùˆ Ø±ØªØ¨Ù‡ -->
    <div class="tab-pane fade {% if active_tab == 'score' %}show active{% endif %}" id="score">
      <div class="text-center mb-4">
        <h5 class="text-primary fw-bold">ğŸ¯ Ø§Ù…ØªÛŒØ§Ø² Ú©Ù„: <span id="totalScore">{{ total_score|floatformat:2 }}</span></h5>
        <h6 class="mb-3">ğŸ† Ø±ØªØ¨Ù‡ Ø´Ù…Ø§ Ø¯Ø± Ø¨ÛŒÙ† Ø§Ø¹Ø¶Ø§: {{ rank|default:"-" }}</h6>
        <div class="progress mb-3">
          {% with progress=total_score|floatformat:0 %}
          <div class="progress-bar bg-success" role="progressbar" style="width: {{ progress }}%" aria-valuenow="{{ progress }}" aria-valuemin="0" aria-valuemax="100">{{ progress }}%</div>
          {% endwith %}
        </div>
      </div>

      <div class="table-responsive" style="max-height:400px; overflow:auto;">
        <table class="table table-striped table-bordered text-center align-middle">
          <thead class="table-primary">
            <tr>
              <th>Ù†ÙˆØ¨Øª</th>
              <th>Ù…Ø¨Ù„Øº ÙˆØ§Ø±ÛŒØ²ÛŒ(ØªÙˆÙ…Ø§Ù†)</th>
              <th>ØªØ§Ø±ÛŒØ® ÙˆØ§Ø±ÛŒØ²</th>
              <th>ØªØ§Ø±ÛŒØ® Ù…ØµÙˆØ¨</th>
              <th>Ø§Ø®ØªÙ„Ø§Ù Ø±ÙˆØ²</th>
              <th>Ø§Ù…ØªÛŒØ§Ø²</th>
            </tr>
          </thead>
          <tbody>
            {% for p in payments %}
              <tr>
                <td>{{ p.installment_number }}</td>
                <td>{{ p.amount}}</td>
                <td>{{ p.payment_date_j }}</td>
                <td>{{ p.due_date_j }}</td>
                <td>{{ p.diff_days }}</td>
                <td>{{ p.score|floatformat:2 }}</td>
              </tr>
            {% empty %}
              <tr><td colspan="6" class="text-center text-muted">Ø¯Ø± Ø­Ø§Ù„ Ù…Ø­Ø§Ø³Ø¨Ù‡...</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

  </div>
</div>
</div>

<script>
$(document).ready(function() {
  const approvedDates = {
    {% for k,v in approved_dates.items %}
      '{{ k }}': '{{ v|default_if_none:""|jformat:"%Y-%m-%d" }}',
    {% endfor %}
  };
  const csrfToken = '{{ csrf_token }}';

  // Persian datepicker
  $("#payment_date").persianDatepicker({
    format: "YYYY-MM-DD", initialValue: false, autoClose: true, calendarType: "persian"
  });

  // ØªØºÛŒÛŒØ± ØªØ§Ø±ÛŒØ® Ù…ØµÙˆØ¨ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†ÙˆØ¨Øª Ø§Ù†ØªØ®Ø§Ø¨ÛŒ
  $('#id_installment_number').on('change', function(){
    const val = $(this).val();
    $('#id_due_date').val(approvedDates[val] || '');
  }).trigger('change');

  // Ø«Ø¨Øª ÙˆØ§Ø±ÛŒØ²ÛŒ Ø¬Ø¯ÛŒØ¯ (AJAX)
  $('#btn_add_payment').on('click', function(){
    const btn = $(this); btn.prop('disabled', true);
    const data = $('#paymentForm').serialize();
    $.post("{% url 'payment_create_ajax' %}", data, function(response){
      if(response.status === 'success'){
        const p = response.payment;
        const newRow = `<tr data-id="${p.id}">
          <td>${p.installment_number}</td>
          <td>${p.amount}</td>
          <td>${p.payment_date}</td>
          <td>${p.due_date}</td>
          <td><button class="btn btn-sm btn-danger delete-btn">Ø­Ø°Ù</button></td>
        </tr>`;
        $('#paymentsTable').append(newRow);
        $('#paymentForm')[0].reset();
        $('#id_due_date').val('');
      } else alert(response.message);
      btn.prop('disabled', false);
    }).fail(function(){ alert('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±'); btn.prop('disabled', false); });
  });

  // Ø­Ø°Ù ÙˆØ§Ø±ÛŒØ²ÛŒ
  $(document).on('click', '.delete-btn', function(){
    const row = $(this).closest('tr');
    const id = row.data('id');
    if(!confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† ÙˆØ§Ø±ÛŒØ²ÛŒ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')) return;
    $.post("{% url 'payment_delete_ajax' pk=0 %}".replace('0', id),
      { csrfmiddlewaretoken: csrfToken },
      function(response){
        if(response.status === 'success') row.remove();
        else alert(response.message);
      });
  });
});
</script>

</body>
</html>
