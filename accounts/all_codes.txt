from django.shortcuts import render, redirect, get_object_or_404
from django.contrib.auth.decorators import login_required, user_passes_test
from django.contrib.auth.views import LoginView
from django.contrib.auth import login
from django.contrib import messages
from django.contrib.auth.models import User
from django.http import JsonResponse,HttpResponse
from django.views.decorators.csrf import csrf_exempt
from .models import Profile, Payment, ApprovedPaymentDate
from .forms import ProfileForm, UserUpdateForm, PaymentForm
import jdatetime
from datetime import datetime
from datetime import date
import pandas as pd
import openpyxl
from .forms import MembersUploadForm
from openpyxl import load_workbook
from datetime import date
import jdatetime
import logging

logger = logging.getLogger(__name__)


# ---------------------- ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ ÛŒØ§ Ù…ÛŒÙ„Ø§Ø¯ÛŒ Ø¨Ù‡ Ù…ÛŒÙ„Ø§Ø¯ÛŒ ----------------------
def parse_date(date_str):
    if not date_str:
        return None
    try:
        jdate = jdatetime.datetime.strptime(date_str, "%Y-%m-%d")
        return jdate.togregorian().date()
    except Exception:
        try:
            return datetime.strptime(date_str, "%Y-%m-%d").date()
        except Exception:
            raise ValueError("ÙØ±Ù…Øª ØªØ§Ø±ÛŒØ® Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª (Ø¨Ø§ÛŒØ¯ Ø´Ù…Ø³ÛŒ ÛŒØ§ Ù…ÛŒÙ„Ø§Ø¯ÛŒ Ø¨Ø§Ø´Ø¯).")

# ---------------------- ØªØ¨Ø¯ÛŒÙ„ Ù…ÛŒÙ„Ø§Ø¯ÛŒ Ø¨Ù‡ Ø´Ù…Ø³ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ----------------------
def to_jalali(date):
    if not date:
        return ''
    if isinstance(date, jdatetime.date):
        return date.strftime("%Y-%m-%d")
    return jdatetime.date.fromgregorian(date=date).strftime("%Y-%m-%d")

# ---------------------- Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ù…ØªÛŒØ§Ø² Ú©Ù„ Ùˆ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ÙˆØ§Ø±ÛŒØ²ÛŒ ----------------------
def calculate_total_score(user):
    payments = Payment.objects.filter(user=user).order_by('installment_number')
    total_score = 0
    payments_data = []
    today = date.today()  # ØªØ§Ø±ÛŒØ® Ø§Ù…Ø±ÙˆØ²
    
    for p in payments:
        if p.payment_date and p.due_date:
            if p.payment_date > p.due_date:
                diff_days = (today - p.payment_date).days
            else:
                diff_days = (today - p.due_date).days
        else:
            diff_days = 0
        
        score = (diff_days * float(p.amount)) / 100_000_000
        total_score += score
        
        payments_data.append({
            'id': p.id,
            'installment_number': p.installment_number,
            'amount': p.amount,
            'payment_date': p.payment_date,
            'payment_date_j': to_jalali(p.payment_date),
            'due_date': p.due_date,
            'due_date_j': to_jalali(p.due_date),
            'diff_days': diff_days,
            'score': score
        })
    return total_score, payments_data

# ---------------------- Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ ----------------------
@login_required
def dashboard(request):
    user = request.user
    profile = Profile.objects.get_or_create(user=user)[0]
    payments = Payment.objects.filter(user=user).order_by('installment_number')
    approved_dates = ApprovedPaymentDate.objects.all()

    total_score, payments_data = calculate_total_score(user)
    approved_dates_list = {p.installment_number: p.due_date for p in approved_dates}

    context = {
        'user': user,
        'profile': profile,
        'payments': payments_data,
        'approved_dates': approved_dates_list,
        'installments': [d.installment_number for d in ApprovedPaymentDate.objects.all().order_by('installment_number')],
        'active_tab': request.GET.get('tab', 'personal'),
        'total_score': total_score
    }
    return render(request, 'accounts/dashboard.html', context)

# ---------------------- AJAX Ø«Ø¨Øª ÙˆØ§Ø±ÛŒØ²ÛŒ ----------------------
@csrf_exempt
@login_required
def payment_create_ajax(request):
    if request.method == 'POST':
        try:
            installment = int(request.POST.get('installment_number'))
            amount = int(request.POST.get('amount'))
            payment_date = parse_date(request.POST.get('payment_date'))
            due_date_obj = ApprovedPaymentDate.objects.filter(installment_number=installment).first()
            due_date_val = due_date_obj.due_date if due_date_obj else None

            payment = Payment.objects.create(
                user=request.user,
                installment_number=installment,
                amount=amount,
                payment_date=payment_date,
                due_date=due_date_val
            )

            total_score, _ = calculate_total_score(request.user)

            return JsonResponse({
                'status': 'success',
                'message': 'âœ… ÙˆØ§Ø±ÛŒØ²ÛŒ Ø«Ø¨Øª Ø´Ø¯',
                'payment': {
                    'id': payment.id,
                    'installment_number': payment.installment_number,
                    'amount': payment.amount,
                    'payment_date': to_jalali(payment.payment_date),
                    'due_date': to_jalali(payment.due_date)
                },
                'total_score': total_score
            })
        except Exception as e:
            return JsonResponse({'status': 'error', 'message': str(e)})
    return JsonResponse({'status': 'error', 'message': 'Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù†Ø§Ù…Ø¹ØªØ¨Ø± âŒ'})

# ---------------------- AJAX ÙˆÛŒØ±Ø§ÛŒØ´ ÙˆØ§Ø±ÛŒØ²ÛŒ ----------------------
@csrf_exempt
@login_required
def payment_edit_ajax(request, pk):
    if request.method == 'POST':
        try:
            payment = get_object_or_404(Payment, pk=pk, user=request.user)
            field = request.POST.get('field')
            value = request.POST.get('value')

            if field == 'installment_number':
                payment.installment_number = int(value)
                due_date_obj = ApprovedPaymentDate.objects.filter(installment_number=value).first()
                payment.due_date = due_date_obj.due_date if due_date_obj else None
            elif field == 'amount':
                payment.amount = int(value)
            elif field == 'payment_date':
                payment.payment_date = parse_date(value)

            payment.save()
            total_score, _ = calculate_total_score(request.user)

            return JsonResponse({
                'status': 'success',
                'message': 'âœ… ÙˆÛŒØ±Ø§ÛŒØ´ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯',
                'payment_date': to_jalali(payment.payment_date),
                'due_date': to_jalali(payment.due_date),
                'total_score': total_score
            })
        except Exception as e:
            return JsonResponse({'status': 'error', 'message': str(e)})
    return JsonResponse({'status': 'error', 'message': 'Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù†Ø§Ù…Ø¹ØªØ¨Ø± âŒ'})

# ---------------------- AJAX Ø­Ø°Ù ÙˆØ§Ø±ÛŒØ²ÛŒ ----------------------
@csrf_exempt
@login_required
def payment_delete_ajax(request, pk):
    if request.method == 'POST':
        payment = get_object_or_404(Payment, pk=pk, user=request.user)
        payment.delete()
        total_score, _ = calculate_total_score(request.user)
        return JsonResponse({'status': 'success', 'message': 'ğŸ—‘ï¸ ÙˆØ§Ø±ÛŒØ²ÛŒ Ø­Ø°Ù Ø´Ø¯', 'total_score': total_score})
    return JsonResponse({'status': 'error', 'message': 'Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù†Ø§Ù…Ø¹ØªØ¨Ø± âŒ'})

# ---------------------- AJAX Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ØªØ¨ Ø§Ù…ØªÛŒØ§Ø² ----------------------
@login_required
def score_ajax(request):
    total_score, payments_data = calculate_total_score(request.user)
    payments_json = [
        {
            'installment_number': p['installment_number'],
            'amount': f"{p['amount']:,}",
            'payment_date': p['payment_date_j'],
            'due_date': p['due_date_j'],
            'diff_days': p['diff_days'],
            'score': round(p['score'], 2)
        } for p in payments_data
    ]
    return JsonResponse({'total_score': total_score, 'payments': payments_json})

# ---------------------- ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ ----------------------
@login_required
def profile_edit(request):
    profile, _ = Profile.objects.get_or_create(user=request.user)
    if request.method == 'POST':
        user_form = UserUpdateForm(request.POST, instance=request.user)
        profile_form = ProfileForm(request.POST, request.FILES, instance=profile)
        if user_form.is_valid() and profile_form.is_valid():
            user_form.save()
            profile_form.save()
            messages.success(request, "âœ… ØªØºÛŒÛŒØ±Ø§Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯")
            return redirect('dashboard')
        else:
            messages.error(request, "âŒ Ø®Ø·Ø§ Ø¯Ø± ÙØ±Ù…")
    else:
        user_form = UserUpdateForm(instance=request.user)
        profile_form = ProfileForm(instance=profile)
    return render(request, 'accounts/profile_edit.html', {
        'user_form': user_form,
        'profile_form': profile_form
    })

# ---------------------- Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ø§Ø±Ø¨Ø± ----------------------
def register(request):
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        password2 = request.POST.get('password2')
        if password != password2:
            messages.error(request, 'Ø±Ù…Ø²Ù‡Ø§ Ù…Ø·Ø§Ø¨Ù‚Øª Ù†Ø¯Ø§Ø±Ù†Ø¯ âŒ')
            return redirect('register')
        if User.objects.filter(username=username).exists():
            messages.error(request, 'Ø§ÛŒÙ† Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øª Ø´Ø¯Ù‡ Ø§Ø³Øª âŒ')
            return redirect('register')
        user = User.objects.create_user(username=username, password=password)
        login(request, user)
        messages.success(request, 'Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯ âœ…')
        return redirect('dashboard')
    return render(request, 'accounts/register.html')

# ---------------------------------------------------------------------------



def is_admin(u):
    return u.is_staff or u.is_superuser



# ---------- ØªÙˆÙ„ÛŒØ¯ ÙØ§ÛŒÙ„ Ù†Ù…ÙˆÙ†Ù‡ ----------
def generate_sample_excel():
    wb = openpyxl.Workbook()
    ws = wb.active
    ws.title = "Members"

    headers = ["Ù†Ø§Ù…", "Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ", "Ú©Ø¯ Ù…Ù„ÛŒ", "Ø´Ù…Ø§Ø±Ù‡ Ù‡Ù…Ø±Ø§Ù‡", "Ø§ÛŒÙ…ÛŒÙ„",
               "Ø´Ù…Ø§Ø±Ù‡ Ø´Ù†Ø§Ø³Ù†Ø§Ù…Ù‡", "Ù†ÙˆØ¨Øª ÙˆØ§Ø±ÛŒØ²ÛŒ", "ØªØ§Ø±ÛŒØ® ÙˆØ§Ø±ÛŒØ²",
               "Ù…Ø¨Ù„Øº ÙˆØ§Ø±ÛŒØ²ÛŒ", "ØªØ§Ø±ÛŒØ® Ù…ØµÙˆØ¨"]
    ws.append(headers)

    for cell in ws[1]:
        cell.font = openpyxl.styles.Font(bold=True)

    sample_row = ["Ù…Ø­Ù…Ø¯", "Ø±ÙˆØ­â€ŒØ§Ù„Ù„Ù‡â€ŒÙ†Ú˜Ø§Ø¯", "Û³Û³Û¹Û²Û°Û´Û¸Û´Û´Û´","09121234567", "test@example.com",
                  "123456", 1, "1404-01-15", 1000000, "1404-01-20"]
    ws.append(sample_row)

    return wb
#------------------------------------------------------------------------------
@login_required
def download_sample_excel(request):
    wb = generate_sample_excel()
    response = HttpResponse(
        content_type='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
    )
    response['Content-Disposition'] = 'attachment; filename="sample_members.xlsx"'
    wb.save(response)
    return response

#-------------------------------------------------------------------------------------
# ---------------------- ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ ÛŒØ§ Ù…ÛŒÙ„Ø§Ø¯ÛŒ Ø¨Ù‡ Ù…ÛŒÙ„Ø§Ø¯ÛŒ ----------------------
def parse_date(date_str):
    """ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ ÛŒØ§ Ù…ÛŒÙ„Ø§Ø¯ÛŒ Ø¨Ù‡ datetime.date"""
    if not date_str:
        return None
    if isinstance(date_str, datetime):
        return date_str.date()
    if isinstance(date_str, date):
        return date_str
    date_str = str(date_str).strip()
    # Ø¨Ø±Ø±Ø³ÛŒ ÙØ±Ù…Øª Ø´Ù…Ø³ÛŒ (Ø³Ø§Ù„ > 1300)
    if '/' in date_str or '-' in date_str:
        parts = date_str.replace('/', '-').split('-')
        if len(parts) == 3:
            y, m, d = map(int, parts)
            if y > 1300:  # Ø´Ù…Ø³ÛŒ
                import jdatetime
                return jdatetime.date(y, m, d).togregorian()
            else:  # Ù…ÛŒÙ„Ø§Ø¯ÛŒ
                return date(y, m, d)
    return None

# ---------------------- Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ Ùˆ Ù¾Ø±Ø¯Ø§Ø²Ø´ ----------------------
# ---------------------- Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ Ùˆ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù¾ÛŒØ´Ø±ÙØªÙ‡ ----------------------


def fix_excel_date(value):
    """
    ØªÙ†Ø¸ÛŒÙ… ØªØ§Ø±ÛŒØ® ÙˆØ±ÙˆØ¯ÛŒ Ø§Ø² Ø§Ú©Ø³Ù„
    Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø²: datetimeØŒ dateØŒ Ø±Ø´ØªÙ‡ØŒ Ù…Ù‚Ø¯Ø§Ø± Ø®Ø§Ù„ÛŒ
    """
    if value is None:
        return None

    # Ø§Ú¯Ø± ØªØ§Ø±ÛŒØ® ÙˆØ§Ù‚Ø¹ÛŒ Ø§Ú©Ø³Ù„ Ø¨Ø§Ø´Ø¯
    if isinstance(value, (datetime.datetime, datetime.date)):
        return value.date() if isinstance(value, datetime.datetime) else value

    # Ø§Ú¯Ø± Ø±Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯
    value = str(value).strip()
    if not value:
        return None

    parsed = parse_date(value)
    return parsed




# ---------------------- Ø¢Ù¾Ù„ÙˆØ¯ Ùˆ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø§Ú©Ø³Ù„ ----------------------

def upload_members_and_payments(request):
    if request.method == "POST" and request.FILES.get("excel_file"):
        excel_file = request.FILES["excel_file"]

        try:
            wb = load_workbook(excel_file, data_only=True)
            sheet = wb.active
        except Exception:
            messages.error(request, "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† ÙØ§ÛŒÙ„. Ù„Ø·ÙØ§Ù‹ ÙØ§ÛŒÙ„ Ø§Ú©Ø³Ù„ Ù…Ø¹ØªØ¨Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù†ÛŒØ¯.")
            return redirect("upload_members_and_payments")

        headers = [str(cell.value).strip() if cell.value else "" for cell in sheet[1]]
        expected_headers = [
            "Ù†Ø§Ù…", "Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ", "Ú©Ø¯ Ù…Ù„ÛŒ", "Ø´Ù…Ø§Ø±Ù‡ Ù‡Ù…Ø±Ø§Ù‡", "Ø§ÛŒÙ…ÛŒÙ„",
            "Ø´Ù…Ø§Ø±Ù‡ Ø´Ù†Ø§Ø³Ù†Ø§Ù…Ù‡", "Ù†ÙˆØ¨Øª ÙˆØ§Ø±ÛŒØ²ÛŒ", "ØªØ§Ø±ÛŒØ® ÙˆØ§Ø±ÛŒØ²", "Ù…Ø¨Ù„Øº ÙˆØ§Ø±ÛŒØ²ÛŒ"
        ]

        missing_headers = [h for h in expected_headers if h not in headers]
        if missing_headers:
            messages.error(request, f"âŒ Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ± Ø¯Ø± ÙØ§ÛŒÙ„ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ù†Ø¯: {', '.join(missing_headers)}")
            return redirect("upload_members_and_payments")

        added_users = 0
        added_payments = 0

        for row in sheet.iter_rows(min_row=2, values_only=True):
            data = dict(zip(headers, row))

            first_name = str(data.get("Ù†Ø§Ù…", "")).strip()
            last_name = str(data.get("Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ", "")).strip()
            national_code = str(data.get("Ú©Ø¯ Ù…Ù„ÛŒ", "")).strip()
            phone = str(data.get("Ø´Ù…Ø§Ø±Ù‡ Ù‡Ù…Ø±Ø§Ù‡", "")).strip()
            email = str(data.get("Ø§ÛŒÙ…ÛŒÙ„", "")).strip()
            birth_certificate = str(data.get("Ø´Ù…Ø§Ø±Ù‡ Ø´Ù†Ø§Ø³Ù†Ø§Ù…Ù‡", "")).strip()

            installment_number = data.get("Ù†ÙˆØ¨Øª ÙˆØ§Ø±ÛŒØ²ÛŒ")
            payment_date = parse_date(data.get("ØªØ§Ø±ÛŒØ® ÙˆØ§Ø±ÛŒØ²"))
            amount = data.get("Ù…Ø¨Ù„Øº ÙˆØ§Ø±ÛŒØ²ÛŒ")

            if not national_code:
                continue

            # ---------------------- Ø§ÛŒØ¬Ø§Ø¯/Ø¢Ù¾Ø¯ÛŒØª Ú©Ø§Ø±Ø¨Ø± ----------------------
            user, created = User.objects.get_or_create(username=national_code)

            if created:
                user.first_name = first_name
                user.last_name = last_name
                user.email = email
                user.set_password(national_code)  # âœ… Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± = Ú©Ø¯ Ù…Ù„ÛŒ
                user.save()
                added_users += 1
            else:
                updated = False
                if user.first_name != first_name:
                    user.first_name = first_name
                    updated = True
                if user.last_name != last_name:
                    user.last_name = last_name
                    updated = True
                if user.email != email:
                    user.email = email
                    updated = True
                if updated:
                    user.save()

            # ---------------------- Ø§ÛŒØ¬Ø§Ø¯/Ø¢Ù¾Ø¯ÛŒØª Ù¾Ø±ÙˆÙØ§ÛŒÙ„ ----------------------
            Profile.objects.update_or_create(
                user=user,
                defaults={
                    "phone_number": phone,
                    "birth_certificate": birth_certificate,
                    "national_code": national_code,
                },
            )

            # ---------------------- Ø«Ø¨Øª ÙˆØ§Ø±ÛŒØ²ÛŒ Ø¨Ø§ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² ØªÚ©Ø±Ø§Ø±ÛŒ ----------------------
            if installment_number and payment_date and amount:
                installment_number = int(installment_number)

                # Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø«Ø¨Øª Ø±Ú©ÙˆØ±Ø¯ ØªÚ©Ø±Ø§Ø±ÛŒ Ú©Ø§Ù…Ù„
                exists_same = Payment.objects.filter(
                    user=user,
                    installment_number=installment_number,
                    payment_date=payment_date,
                    amount=amount
                ).exists()

                if exists_same:
                    continue  # Ø±Ú©ÙˆØ±Ø¯ ØªÚ©Ø±Ø§Ø±ÛŒ â†’ Ø«Ø¨Øª Ù†Ø´ÙˆØ¯

                # ØªØ§Ø±ÛŒØ® Ù…ØµÙˆØ¨ Ø§Ø² Ù…Ø¯ÛŒØ±ÛŒØª Ú¯Ø±ÙØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
                approved_date_obj, _ = ApprovedPaymentDate.objects.get_or_create(
                    installment_number=installment_number,
                    defaults={"due_date": None},
                )

                Payment.objects.create(
                    user=user,
                    installment_number=installment_number,
                    amount=amount,
                    payment_date=payment_date,
                    due_date=approved_date_obj.due_date
                )
                added_payments += 1

        msg = (
            f"âœ… ÙØ§ÛŒÙ„ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø´Ø¯. "
            f"{added_users} Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯ØŒ "
            f"{added_payments} Ø±Ú©ÙˆØ±Ø¯ ÙˆØ§Ø±ÛŒØ²ÛŒ Ø«Ø¨Øª Ø´Ø¯."
        )
        messages.success(request, msg)
        return redirect("upload_members_and_payments")

    return render(request, "accounts/upload_members_and_payments.html")



# ---------------------- ÙˆØ±ÙˆØ¯ Ú©Ø§Ø±Ø¨Ø± ----------------------
class CustomLoginView(LoginView):
    template_name = 'accounts/login.html'
    def form_valid(self, form):
        messages.success(self.request, f"Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ {self.request.user.username} ğŸŒ·")
        return super().form_valid(form)



from django.urls import path
from django.contrib.auth.views import LogoutView, PasswordChangeView
from .views import (
    CustomLoginView, dashboard, profile_edit,
    payment_create_ajax, payment_edit_ajax, payment_delete_ajax,
    score_ajax, upload_members_and_payments, download_sample_excel
)

urlpatterns = [
    # ----------------- ØµÙØ­Ø§Øª Ø§ØµÙ„ÛŒ -----------------
    path('', dashboard, name='dashboard'),
    path('dashboard/', dashboard, name='dashboard'),

    # ØµÙØ­Ù‡ ÙˆØ±ÙˆØ¯
    path('login/', CustomLoginView.as_view(), name='login'),

    # Ø®Ø±ÙˆØ¬ Ø§Ø² Ø­Ø³Ø§Ø¨
    path('logout/', LogoutView.as_view(next_page='login'), name='logout'),

    # ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾Ø±ÙˆÙØ§ÛŒÙ„
    path('profile/edit/', profile_edit, name='profile_edit'),

    # ØªØºÛŒÛŒØ± Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±
    path(
        'password_change/',
        PasswordChangeView.as_view(
            template_name='accounts/password_change.html',
            success_url='/dashboard/'
        ),
        name='password_change'
    ),

    # ----------------- Ù…Ø³ÛŒØ±Ù‡Ø§ÛŒ AJAX -----------------
    path('payments/create/', payment_create_ajax, name='payment_create_ajax'),
    path('payments/<int:pk>/edit/', payment_edit_ajax, name='payment_edit_ajax'),
    path('payments/<int:pk>/delete/', payment_delete_ajax, name='payment_delete_ajax'),
    path('payments/score/', score_ajax, name='score_ajax'),

    # ----------------- Ø¢Ù¾Ù„ÙˆØ¯ Ø§Ú©Ø³Ù„ -----------------
    path('upload-members/', upload_members_and_payments, name='upload_members_and_payments'),
    path('download-sample-excel/', download_sample_excel, name='download_sample_excel'),
]



from django.db import models
from django.contrib.auth.models import User
from django.db.models.signals import post_save
from django.dispatch import receiver
from django_jalali.db import models as jmodels  # Ø¨Ø±Ø§ÛŒ ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ


# Ù…Ø¯Ù„ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ú©Ø§Ø±Ø¨Ø±
class Profile(models.Model):
    user = models.OneToOneField(User, on_delete=models.CASCADE)
    login_count = models.IntegerField(default=0)

    # Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ø®ØµÛŒ
    first_name = models.CharField(max_length=50, blank=True, verbose_name="Ù†Ø§Ù…")
    last_name = models.CharField(max_length=50, blank=True, verbose_name="Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ")
    national_code = models.CharField(max_length=10, blank=True, verbose_name="Ø´Ù…Ø§Ø±Ù‡ Ù…Ù„ÛŒ")
    birth_certificate = models.CharField(max_length=10, blank=True, verbose_name="Ø´Ù…Ø§Ø±Ù‡ Ø´Ù†Ø§Ø³Ù†Ø§Ù…Ù‡")
    phone_number = models.CharField(max_length=11, blank=True, verbose_name="Ø´Ù…Ø§Ø±Ù‡ Ù‡Ù…Ø±Ø§Ù‡")
    birth_date = jmodels.jDateField(blank=True, null=True, verbose_name="ØªØ§Ø±ÛŒØ® ØªÙˆÙ„Ø¯ (Ø´Ù…Ø³ÛŒ)")
    birth_place = models.CharField(max_length=100, blank=True, verbose_name="Ù…Ø­Ù„ ØªÙˆÙ„Ø¯")

    # Ø¹Ú©Ø³ Ù¾Ø±ÙˆÙØ§ÛŒÙ„
    image = models.ImageField(upload_to='profile_pics/', default='default.jpg')

    def __str__(self):
        return f"{self.user.username} Profile"


# Ù…Ø¯Ù„ ÙˆØ§Ø±ÛŒØ²ÛŒâ€ŒÙ‡Ø§ (Ù‚Ø§Ø¨Ù„ Ø«Ø¨Øª Ú†Ù†Ø¯Ø¨Ø§Ø± Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ù†ÙˆØ¨Øª)
PAYMENT_CHOICES = [(i, f"Ù†ÙˆØ¨Øª ÙˆØ§Ø±ÛŒØ²ÛŒ {i}") for i in range(1, 11)]

class Payment(models.Model):
    user = models.ForeignKey(User, on_delete=models.CASCADE, related_name='payments')
    installment_number = models.IntegerField(choices=PAYMENT_CHOICES, verbose_name="Ù†ÙˆØ¨Øª ÙˆØ§Ø±ÛŒØ²")
    amount = models.DecimalField(max_digits=12, decimal_places=2, verbose_name="Ù…Ø¨Ù„Øº ÙˆØ§Ø±ÛŒØ²ÛŒ")
    payment_date = jmodels.jDateField(verbose_name="ØªØ§Ø±ÛŒØ® ÙˆØ§Ø±ÛŒØ² (Ø´Ù…Ø³ÛŒ)")
    due_date = models.DateField(blank=True, null=True, verbose_name="ØªØ§Ø±ÛŒØ® Ø³Ø±Ø±Ø³ÛŒØ¯ Ø§Ø¹Ù„Ø§Ù…ÛŒ ØªØ¹Ø§ÙˆÙ†ÛŒ")
    created_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        ordering = ['installment_number', 'payment_date']
        verbose_name = "ÙˆØ§Ø±ÛŒØ²"
        verbose_name_plural = "ÙˆØ§Ø±ÛŒØ²ÛŒâ€ŒÙ‡Ø§"

    def __str__(self):
        return f"{self.user.username} - Ù†ÙˆØ¨Øª {self.installment_number} - Ù…Ø¨Ù„Øº {self.amount}"


# ØªØ§Ø±ÛŒØ® Ø§Ø¹Ù„Ø§Ù…ÛŒ ÙˆØ§Ø±ÛŒØ²ÛŒ ØªÙˆØ³Ø· ØªØ¹Ø§ÙˆÙ†ÛŒ
class ApprovedPaymentDate(models.Model):
    installment_number = models.PositiveSmallIntegerField(unique=True)
    due_date = models.DateField()

    class Meta:
        ordering = ['installment_number']

    def __str__(self):
        return f"Ù†ÙˆØ¨Øª {self.installment_number} - {self.due_date}"


# Ø³ÛŒÚ¯Ù†Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ø®ÙˆØ¯Ú©Ø§Ø± Ù¾Ø±ÙˆÙØ§ÛŒÙ„
@receiver(post_save, sender=User)
def create_profile(sender, instance, created, **kwargs):
    if created:
        Profile.objects.create(user=instance)

@receiver(post_save, sender=User)
def save_profile(sender, instance, **kwargs):
    if hasattr(instance, 'profile'):
        instance.profile.save()


from django import forms
from django.contrib.auth.models import User
from .models import Profile
import jdatetime
from datetime import date
from .models import Payment, ApprovedPaymentDate


class UserUpdateForm(forms.ModelForm):
    class Meta:
        model = User
        fields = ['first_name', 'last_name', 'email']
        widgets = {
            'first_name': forms.TextInput(attrs={'class': 'form-control', 'placeholder': 'Ù†Ø§Ù…'}),
            'last_name': forms.TextInput(attrs={'class': 'form-control', 'placeholder': 'Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ'}),
            'email': forms.EmailInput(attrs={'class': 'form-control', 'placeholder': 'Ø§ÛŒÙ…ÛŒÙ„'}),
        }


class ProfileForm(forms.ModelForm):
    class Meta:
        model = Profile
        fields = [
            'first_name', 'last_name', 'national_code',
            'birth_certificate', 'phone_number', 'birth_date', 'birth_place'
        ]
        widgets = {
            'first_name': forms.TextInput(attrs={'class': 'form-control', 'placeholder': 'Ù†Ø§Ù…'}),
            'last_name': forms.TextInput(attrs={'class': 'form-control', 'placeholder': 'Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ'}),
            'national_code': forms.TextInput(attrs={'class': 'form-control', 'placeholder': 'Ø´Ù…Ø§Ø±Ù‡ Ù…Ù„ÛŒ'}),
            'birth_certificate': forms.TextInput(attrs={'class': 'form-control', 'placeholder': 'Ø´Ù…Ø§Ø±Ù‡ Ø´Ù†Ø§Ø³Ù†Ø§Ù…Ù‡'}),
            'phone_number': forms.TextInput(attrs={'class': 'form-control', 'placeholder': 'Ø´Ù…Ø§Ø±Ù‡ Ù‡Ù…Ø±Ø§Ù‡'}),
            'birth_date': forms.TextInput(attrs={'class': 'form-control', 'placeholder': 'ØªØ§Ø±ÛŒØ® ØªÙˆÙ„Ø¯ Ø´Ù…Ø³ÛŒ (Ù…Ø«Ù„Ø§Ù‹ 1402-07-20)'}),
            'birth_place': forms.TextInput(attrs={'class': 'form-control', 'placeholder': 'Ù…Ø­Ù„ ØªÙˆÙ„Ø¯'}),
        }



class MembersUploadForm(forms.Form):
    file = forms.FileField(label="Ø§Ù†ØªØ®Ø§Ø¨ ÙØ§ÛŒÙ„ Excel Ø§Ø¹Ø¶Ø§ Ùˆ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§")


class PaymentForm(forms.ModelForm):
    payment_date = forms.CharField(label="ØªØ§Ø±ÛŒØ® ÙˆØ§Ø±ÛŒØ²", widget=forms.TextInput(attrs={'class':'form-control'}))
    due_date = forms.CharField(label="ØªØ§Ø±ÛŒØ® Ù…ØµÙˆØ¨", required=False, widget=forms.TextInput(attrs={'class':'form-control','readonly':'readonly'}))
    installment_number = forms.ChoiceField(label="Ù†ÙˆØ¨Øª ÙˆØ§Ø±ÛŒØ²ÛŒ", widget=forms.Select(attrs={'class':'form-select'}))

    class Meta:
        model = Payment
        fields = ['installment_number','due_date','amount','payment_date']

    def __init__(self,*args,**kwargs):
        super().__init__(*args,**kwargs)
        approved_dates = ApprovedPaymentDate.objects.all()
        if approved_dates.exists():
            self.fields['installment_number'].choices = [(p.installment_number,f"Ù†ÙˆØ¨Øª {p.installment_number}") for p in approved_dates]
        else:
            self.fields['installment_number'].choices = [(i,f"Ù†ÙˆØ¨Øª {i}") for i in range(1,13)]

        if self.instance and self.instance.pk:
            try:
                due = ApprovedPaymentDate.objects.get(installment_number=self.instance.installment_number)
                self.fields['due_date'].initial = due.due_date
            except ApprovedPaymentDate.DoesNotExist:
                self.fields['due_date'].initial = ''

    def clean_payment_date(self):
        date_str = self.cleaned_data['payment_date'].strip()
        try:
            if '/' in date_str and int(date_str.split('/')[0])>1300:
                jdate = jdatetime.date.fromisoformat(date_str.replace('/','-'))
                return jdate.togregorian()
            y,m,d = map(int,date_str.replace('/','-').split('-'))
            return date(y,m,d)
        except:
            raise forms.ValidationError("ØªØ§Ø±ÛŒØ® Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª")

    def clean(self):
        cleaned_data = super().clean()
        installment = int(cleaned_data.get('installment_number'))
        try:
            due = ApprovedPaymentDate.objects.get(installment_number=installment)
            cleaned_data['due_date'] = due.due_date
        except ApprovedPaymentDate.DoesNotExist:
            cleaned_data['due_date'] = ''
        return cleaned_data


from django.contrib import admin
from .models import ApprovedPaymentDate

@admin.register(ApprovedPaymentDate)
class ApprovedPaymentDateAdmin(admin.ModelAdmin):
    list_display = ('installment_number', 'due_date')
    list_editable = ('due_date',)
    ordering = ('installment_number',)


{% load static %}
{% load humanize %}
{% load jformat %}
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ú©Ø§Ø±Ø¨Ø±</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- Persian Datepicker -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css">
<script src="https://cdn.jsdelivr.net/npm/persian-date@1.1.0/dist/persian-date.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>

<style>
body {
  background: linear-gradient(135deg, #5b9bd5, #2b5797);
  font-family: "Vazirmatn", sans-serif;
  color: #fff;
  min-height: 100vh;
  padding: 20px 0;
}
.container { max-width: 1000px; }
.card {
  background: rgba(255, 255, 255, 0.95);
  border-radius: 20px;
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
  padding: 2rem;
}
.table th {
  background: linear-gradient(90deg, #007bff, #00bfff);
  color: #fff;
  font-weight: bold;
}
.table td { color: #000; }
.table-hover tbody tr:hover { background-color: rgba(0, 123, 255, 0.1); }
.btn-edit { background-color: #00bfff; border: none; color: #fff; font-weight: bold; transition: 0.3s; }
.btn-edit:hover { background-color: #0099cc; }
.btn-logout { background-color: #e74c3c; border: none; color: #fff; font-weight: bold; }
.profile-header img { box-shadow: 0 0 10px rgba(0, 123, 255, 0.5); }
.info-item { background: rgba(0, 123, 255, 0.1); padding: 10px; border-radius: 10px; margin-bottom: 8px; display: flex; justify-content: space-between; flex-wrap: wrap; }
.nav-tabs .nav-link { cursor: pointer; }
@media(max-width:576px){ .info-item { flex-direction: column; align-items: flex-start; } }
</style>
</head>
<body>

<div class="container">
<div class="card">
  <div class="profile-header text-center mb-3">
    {% if profile.image %}
      <img src="{{ profile.image.url }}" class="rounded-circle border border-info mb-2" width="120" height="120">
    {% else %}
      <img src="{% static 'default.jpg' %}" width="120" height="120">
    {% endif %}
    <h4 class="mt-2 text-primary">ğŸ‘‹ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒ {{ user.username }}</h4>
  </div>

  <!-- ØªØ¨â€ŒÙ‡Ø§ -->
  <ul class="nav nav-tabs mb-3 flex-wrap">
    <li class="nav-item"><button class="nav-link {% if active_tab == 'personal' %}active{% endif %}" data-bs-toggle="tab" data-bs-target="#personal">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù‡ÙˆÛŒØªÛŒ</button></li>
    <li class="nav-item"><button class="nav-link {% if active_tab == 'financial' %}active{% endif %}" data-bs-toggle="tab" data-bs-target="#financial">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø§Ù„ÛŒ</button></li>
    <li class="nav-item"><button class="nav-link {% if active_tab == 'score' %}active{% endif %}" data-bs-toggle="tab" data-bs-target="#score">Ø§Ù…ØªÛŒØ§Ø² Ø¹Ø¶Ùˆ</button></li>
  </ul>

  <div class="tab-content">
    <!-- ØªØ¨ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù‡ÙˆÛŒØªÛŒ -->
    <div class="tab-pane fade {% if active_tab == 'personal' %}show active{% endif %}" id="personal">
      <div class="info-item"><strong>Ù†Ø§Ù…:</strong> <span>{{ user.first_name|default:"-" }}</span></div>
      <div class="info-item"><strong>Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ:</strong> <span>{{ user.last_name|default:"-" }}</span></div>
      <div class="info-item"><strong>Ø§ÛŒÙ…ÛŒÙ„:</strong> <span>{{ user.email|default:"-" }}</span></div>
      <div class="info-item"><strong>Ø´Ù…Ø§Ø±Ù‡ Ù…Ù„ÛŒ:</strong> <span>{{ profile.national_code|default:"-" }}</span></div>
      <div class="info-item"><strong>Ø´Ù…Ø§Ø±Ù‡ Ø´Ù†Ø§Ø³Ù†Ø§Ù…Ù‡:</strong> <span>{{ profile.birth_certificate|default:"-" }}</span></div>
      <div class="info-item"><strong>Ø´Ù…Ø§Ø±Ù‡ Ù‡Ù…Ø±Ø§Ù‡:</strong> <span>{{ profile.phone_number|default:"-" }}</span></div>
      <div class="info-item"><strong>ØªØ§Ø±ÛŒØ® ØªÙˆÙ„Ø¯:</strong> <span>{{ profile.birth_date|default_if_none:"-"|jformat:"%Y-%m-%d" }}</span></div>
      <div class="info-item"><strong>Ù…Ø­Ù„ ØªÙˆÙ„Ø¯:</strong> <span>{{ profile.birth_place|default:"-" }}</span></div>

      <div class="text-center mt-4 d-flex flex-column gap-2">
        <a href="{% url 'profile_edit' %}" class="btn btn-edit w-100">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾Ø±ÙˆÙØ§ÛŒÙ„</a>
        <form method="post" action="{% url 'logout' %}">{% csrf_token %}
          <button type="submit" class="btn btn-logout w-100">ğŸšª Ø®Ø±ÙˆØ¬</button>
        </form>
      </div>
    </div>

    <!-- ØªØ¨ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø§Ù„ÛŒ -->
    <div class="tab-pane fade {% if active_tab == 'financial' %}show active{% endif %}" id="financial">
      <form id="paymentForm" class="payment-form mt-3">
        {% csrf_token %}
        <div class="row g-3">
          <div class="col-md-4">
            <label>Ù†ÙˆØ¨Øª ÙˆØ§Ø±ÛŒØ²ÛŒ</label>
            <select name="installment_number" id="id_installment_number" class="form-select">
              {% for i in installments %}
                <option value="{{ i }}">Ù†ÙˆØ¨Øª {{ i }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-4">
            <label>Ù…Ø¨Ù„Øº (Ø±ÛŒØ§Ù„)</label>
            <input type="number" name="amount" class="form-control" required min="1">
          </div>
          <div class="col-md-4">
            <label>ØªØ§Ø±ÛŒØ® ÙˆØ§Ø±ÛŒØ²</label>
            <input type="text" id="payment_date" name="payment_date" class="form-control" placeholder="YYYY-MM-DD" required>
          </div>
          <div class="col-md-4 mt-3">
            <label>ØªØ§Ø±ÛŒØ® Ù…ØµÙˆØ¨ ÙˆØ§Ø±ÛŒØ²ÛŒ</label>
            <input type="text" id="id_due_date" name="due_date" class="form-control" readonly>
          </div>
        </div>
        <div class="text-center mt-3">
          <button type="submit" class="btn btn-edit w-50">ğŸ’¾ Ø«Ø¨Øª ÙˆØ§Ø±ÛŒØ²ÛŒ</button>
        </div>
      </form>

      <div id="alertBox" class="mt-3"></div>

      <div class="table-responsive mt-3">
        <table class="table table-hover" id="paymentsTable">
          <thead>
            <tr>
              <th>Ù†ÙˆØ¨Øª</th>
              <th>Ù…Ø¨Ù„Øº</th>
              <th>ØªØ§Ø±ÛŒØ® ÙˆØ§Ø±ÛŒØ²</th>
              <th>ØªØ§Ø±ÛŒØ® Ù…ØµÙˆØ¨</th>
              <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
            </tr>
          </thead>
          <tbody>
            {% for p in payments %}
              <tr data-id="{{ p.id }}">
                <td class="editable" data-field="installment_number">{{ p.installment_number }}</td>
                <td class="editable" data-field="amount">{{ p.amount|intcomma }}</td>
                <td class="editable" data-field="payment_date">{{ p.payment_date_j }}</td>
                <td>{{ p.due_date_j }}</td>
                <td><button class="btn btn-sm btn-danger delete-btn">Ø­Ø°Ù</button></td>
              </tr>
            {% empty %}
              <tr><td colspan="5" class="text-center text-warning">Ù‡Ù†ÙˆØ² ÙˆØ§Ø±ÛŒØ²ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- ØªØ¨ Ø§Ù…ØªÛŒØ§Ø² -->
    <div class="tab-pane fade {% if active_tab == 'score' %}show active{% endif %}" id="score">
      <div class="text-center mt-4">
        <h5 class="text-primary fw-bold">ğŸ¯ Ø§Ù…ØªÛŒØ§Ø² Ú©Ù„: <span id="totalScore">{{ total_score|floatformat:2 }}</span></h5>
      </div>

      <div class="table-responsive mt-4">
        <table class="table table-striped table-bordered text-center align-middle" id="scoreTable">
          <thead class="table-primary">
            <tr>
              <th>Ù†ÙˆØ¨Øª</th>
              <th>Ù…Ø¨Ù„Øº ÙˆØ§Ø±ÛŒØ²ÛŒ</th>
              <th>ØªØ§Ø±ÛŒØ® ÙˆØ§Ø±ÛŒØ²</th>
              <th>ØªØ§Ø±ÛŒØ® Ù…ØµÙˆØ¨</th>
              <th>Ø§Ø®ØªÙ„Ø§Ù Ø±ÙˆØ²</th>
              <th>Ø§Ù…ØªÛŒØ§Ø²</th>
            </tr>
          </thead>
          <tbody id="scoreTableBody">
            {% for p in payments %}
              <tr>
                <td>{{ p.installment_number }}</td>
                <td>{{ p.amount|intcomma }}</td>
                <td>{{ p.payment_date_j }}</td>
                <td>{{ p.due_date_j }}</td>
                <td>{{ p.diff_days }}</td>
                <td>{{ p.score|floatformat:2 }}</td>
              </tr>
            {% empty %}
              <tr><td colspan="6" class="text-center text-muted">Ø¯Ø± Ø­Ø§Ù„ Ù…Ø­Ø§Ø³Ø¨Ù‡...</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
</div>

<script>
$(document).ready(function() {
  const approvedDates = {
    {% for k,v in approved_dates.items %}
      '{{ k }}': '{{ v|default_if_none:""|jformat:"%Y-%m-%d" }}',
    {% endfor %}
  };
  const csrfToken = '{{ csrf_token }}';

  $("#payment_date").persianDatepicker({
    format: "YYYY-MM-DD", initialValue: false, autoClose: true, calendarType: "persian"
  });

  $('#id_installment_number').on('change', function(){
    const val = $(this).val();
    $('#id_due_date').val(approvedDates[val] || '');
  }).trigger('change');

  // ğŸ”¹ ØªØ§Ø¨Ø¹ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªØ¨ Ø§Ù…ØªÛŒØ§Ø²
  function updateScoreTab() {
    $.get("{% url 'score_ajax' %}", function (data) {
      $("#totalScore").text(data.total_score.toFixed(2));
      const tbody = $("#scoreTableBody");
      tbody.empty();
      data.payments.forEach(p => {
        const row = `<tr>
          <td>${p.installment_number}</td>
          <td>${p.amount}</td>
          <td>${p.payment_date}</td>
          <td>${p.due_date}</td>
          <td>${p.diff_days}</td>
          <td>${p.score}</td>
        </tr>`;
        tbody.append(row);
      });
    });
  }

  // Ø«Ø¨Øª ÙˆØ§Ø±ÛŒØ²ÛŒ
  $('#paymentForm').on('submit', function (e) {
    e.preventDefault();
    $.ajax({
      type: 'POST',
      url: "{% url 'payment_create_ajax' %}",
      data: $(this).serialize(),
      beforeSend: xhr => xhr.setRequestHeader("X-CSRFToken", csrfToken),
      success: function (response) {
        if (response.status === 'success') {
          const p = response.payment;
          const newRow = `<tr data-id="${p.id}">
              <td class="editable" data-field="installment_number">${p.installment_number}</td>
              <td class="editable" data-field="amount">${p.amount}</td>
              <td class="editable" data-field="payment_date">${p.payment_date}</td>
              <td>${p.due_date}</td>
              <td><button class="btn btn-sm btn-danger delete-btn">Ø­Ø°Ù</button></td>
            </tr>`;
          $('#paymentsTable tbody').append(newRow);
          updateScoreTab(); // ğŸ”¹ ØªØ¨ Ø§Ù…ØªÛŒØ§Ø² Ø¨Ù„Ø§ÙØ§ØµÙ„Ù‡ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´ÙˆØ¯
        } else alert(response.message);
      }
    });
  });

  // Ø­Ø°Ù
  $(document).on('click', '.delete-btn', function () {
    const row = $(this).closest('tr');
    const id = row.data('id');
    if (!confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† ÙˆØ§Ø±ÛŒØ²ÛŒ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')) return;
    $.post("{% url 'payment_delete_ajax' pk=0 %}".replace('0', id),
      { csrfmiddlewaretoken: csrfToken },
      function (response) {
        if (response.status === 'success') { row.remove(); updateScoreTab(); }
        else alert(response.message);
      });
  });

  // ÙˆÛŒØ±Ø§ÛŒØ´
  $(document).on('click', '.editable', function () {
    const td = $(this);
    const oldValue = td.text().trim();
    const field = td.data('field');
    const id = td.closest('tr').data('id');
    if (td.find('input').length) return;
    const input = $('<input type="text" class="form-control form-control-sm">').val(oldValue);
    td.empty().append(input).focus();

    input.on('blur keydown', function (e) {
      if (e.type === 'blur' || e.key === 'Enter') {
        const newValue = input.val().trim();
        if (newValue && newValue !== oldValue) {
          $.post("{% url 'payment_edit_ajax' pk=0 %}".replace('0', id),
            { field, value: newValue, csrfmiddlewaretoken: csrfToken },
            function (response) {
              if (response.status === 'success') { td.text(newValue); updateScoreTab(); }
              else td.text(oldValue);
            });
        } else td.text(oldValue);
      }
    });
  });
});
</script>

</body>
</html>


{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mt-5">
    <h2 class="mb-4 text-center">Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø¹Ø¶Ø§ Ùˆ ÙˆØ§Ø±ÛŒØ²ÛŒâ€ŒÙ‡Ø§</h2>

    <!-- Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert {% if message.tags %}alert-{{ message.tags }}{% else %}alert-info{% endif %} alert-dismissible fade show" role="alert">
                {{ message|safe }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}

    <div class="row">
        <!-- Ú©Ø§Ø±Øª Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ Ù†Ù…ÙˆÙ†Ù‡ -->
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-body text-center">
                    <h5 class="card-title">ÙØ§ÛŒÙ„ Ù†Ù…ÙˆÙ†Ù‡ Ø§Ú©Ø³Ù„</h5>
                    <p class="card-text">Ø¨Ø±Ø§ÛŒ Ø¢Ù¾Ù„ÙˆØ¯ ØµØ­ÛŒØ­ Ø§Ø¹Ø¶Ø§ Ùˆ ÙˆØ§Ø±ÛŒØ²ÛŒâ€ŒÙ‡Ø§ Ø§Ø² ÙØ§ÛŒÙ„ Ù†Ù…ÙˆÙ†Ù‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.</p>
                    <a href="{% url 'download_sample_excel' %}" class="btn btn-success">
                        Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ Ù†Ù…ÙˆÙ†Ù‡
                    </a>
                </div>
            </div>
        </div>

        <!-- Ú©Ø§Ø±Øª Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ -->
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title text-center">Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ Ø§Ø¹Ø¶Ø§ Ùˆ ÙˆØ§Ø±ÛŒØ²ÛŒâ€ŒÙ‡Ø§</h5>
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="excel_file" class="form-label">Ø§Ù†ØªØ®Ø§Ø¨ ÙØ§ÛŒÙ„ Ø§Ú©Ø³Ù„</label>
                            <input type="file" name="excel_file" id="excel_file" class="form-control" required>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">Ø¢Ù¾Ù„ÙˆØ¯ Ùˆ Ù¾Ø±Ø¯Ø§Ø²Ø´</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}
